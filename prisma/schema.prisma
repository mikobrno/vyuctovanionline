// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Autentizace a uživatelé
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String
  role          UserRole  @default(OWNER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  owners        Owner[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER  // Správce SVJ
  OWNER    // Vlastník
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Hlavní entity aplikace

// Bytový dům
model Building {
  id            String   @id @default(cuid())
  name          String
  address       String
  city          String
  zip           String
  ico           String?
  bankAccount   String?
  managerName   String?  // Správce budovy (z Excelu: Vstupni data B34)
  managerEmail  String?  // Email domovníka
  managerPhone  String?  // Telefon domovníka
  email         String?  // Email pro hlášení
  
  // Globální parametry budovy pro výpočty
  totalArea         Float?   // Užitná plocha domu - celková
  chargeableArea    Float?   // Užitná plocha domu - započitatelná
  chimneysCount     Int?     // Počet komínů
  totalPeople       Int?     // Počet osob (celkem/výtah)
  unitCountOverride Int?     // Ruční přepsání počtu jednotek (pokud se liší od DB)

  // Nastavení šablon
  emailTemplateSubject String?   @db.Text
  emailTemplateBody    String?   @db.Text
  smsTemplateBody      String?   @db.Text

  createdAt     DateTime  @default(now())
  updatedAt     DateTime @updatedAt

  units         Unit[]
  services      Service[]
  costs         Cost[]
  billingPeriods BillingPeriod[]
  calculationConfigs CalculationConfig[]

  @@map("buildings")
}

// Jednotka (byt, garáž, sklep)
model Unit {
  id                    String   @id @default(cuid())
  buildingId            String
  unitNumber            String
  type                  UnitType @default(APARTMENT)
  shareNumerator        Int
  shareDenominator      Int
  totalArea             Float
  floorArea             Float?
  residents             Int?
  variableSymbol        String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  building              Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  ownerships            Ownership[]
  meters                Meter[]
  advancePaymentRecords AdvancePaymentRecord[]
  advanceMonthlies      AdvanceMonthly[]
  payments              Payment[]
  billingResults        BillingResult[]
  personMonths          PersonMonth[]
  parameters            UnitParameter[]

  @@unique([buildingId, unitNumber])
  @@map("units")
}

model UnitParameter {
  id        String   @id @default(cuid())
  unitId    String
  name      String   // Název parametru (např. "Počet radiátorů", "Plocha balkonu")
  value     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unit      Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, name])
  @@map("unit_parameters")
}

enum UnitType {
  APARTMENT
  GARAGE
  CELLAR
  NON_RESIDENTIAL
}

// Vlastník
model Owner {
  id            String   @id @default(cuid())
  firstName     String
  lastName      String
  email         String?
  phone         String?
  address       String?
  bankAccount   String?
  salutation    String?  // oslovení pro e-maily
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  ownerships    Ownership[]
  userId        String?  @unique
  user          User?    @relation(fields: [userId], references: [id])

  @@map("owners")
}

// Vlastnictví - historie (vlastník může změnit v průběhu roku)
model Ownership {
  id            String    @id @default(cuid())
  unitId        String
  ownerId       String
  validFrom     DateTime
  validTo       DateTime?
  sharePercent  Float     @default(100) // pro spoluvlastnictví
  createdAt     DateTime  @default(now())

  unit          Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  owner         Owner     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("ownerships")
}

// Služba (Teplo, Vodné, Správa, atd.)
model Service {
  id                  String              @id @default(cuid())
  buildingId          String
  name                String              // např. "Teplo", "TUV", "Správa"
  code                String              // zkratka
  methodology         CalculationMethod   @default(OWNERSHIP_SHARE) // způsob rozúčtování
  
  // NOVÁ POLE PRO DYNAMICKÝ ENGINE
  dataSourceType      DataSourceType?     // typ datového zdroje (METER_DATA, UNIT_ATTRIBUTE, UNIT_COUNT, NONE)
  dataSourceName      String?             // název záložky/zdroje (např. "Vodoměry SV", "Teplo")
  dataSourceColumn    String?             // sloupec ze zdroje (např. "Spotřeba za období", "consumption")
  unitAttributeName   String?             // název atributu jednotky (např. "Vlastnický podíl", "Celková výměra")
  
  measurementUnit     String?             // jednotka měření (m³, kWh, osobo-měsíc)
  unitPrice           Float?              // cena za jednotku
  fixedAmountPerUnit  Float?              // fixní částka na jednotku (např. Kč/byt)
  divisor             Float?              // ruční dělitel (např. pro Rovným dílem - místo počtu jednotek)
  manualCost          Float?              // ruční přepis celkového nákladu (Náklad [D])
  manualShare         Float?              // ruční přepis podílu služby v % (Podíl [C])
  customFormula       String?             // vlastní vzorec pro výpočet
  advancePaymentColumn String?            // odkaz na sloupec v předpisu záloh
  excelColumn         String?             // EXPLICITNÍ ADRESOVÁNÍ: Sloupec v Excelu (např. "BN")
  order               Int                 @default(0)
  isActive            Boolean             @default(true)
  showOnStatement     Boolean             @default(true) // zobrazit na výpisu
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  building            Building            @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  costs               Cost[]
  meters              Meter[]
  advancePayments     AdvancePayment[]
  advanceMonthlies    AdvanceMonthly[]
  billingServiceCosts BillingServiceCost[]

  @@unique([buildingId, code])
  @@map("services")
}

// Způsoby výpočtu služeb
enum CalculationMethod {
  OWNERSHIP_SHARE  // Podle vlastnického podílu
  AREA             // Podle podlahové plochy
  PERSON_MONTHS    // Podle počtu osob (osobo-měsíců)
  METER_READING    // Podle odečtu měřidel
  FIXED_PER_UNIT   // Fixní částka na byt (dle počtu jednotek)
  EQUAL_SPLIT      // Rovním dílem
  NO_BILLING       // Nevyúčtovávat (např. Fond oprav)
  CUSTOM           // Vlastní vzorec
  UNIT_PARAMETER   // Podle parametru jednotky (z Excelu)
}

// NOVÉ ENUMY PRO DYNAMICKÝ ENGINE
enum DataSourceType {
  METER_DATA        // Data z měřidel (např. Vodoměry SV, TUV, Teplo, Elektřina)
  UNIT_ATTRIBUTE    // Atribut jednotky (vlastnický podíl, výměra)
  PERSON_MONTHS     // Počet osob za období
  UNIT_COUNT        // Počet jednotek (rovným dílem)
  FIXED_AMOUNT      // Fixní částka
  NONE              // Nevyúčtovávat
}

enum MeterDataSource {
  VODOMER_SV        // Studená voda
  VODOMER_TUV       // Teplá užitková voda
  TEPLO             // Teplo (ústřední vytápění)
  ELEKTROMER        // Elektřina
}

enum UnitAttributeSource {
  VLASTNICKY_PODIL  // Vlastnický podíl (shareNumerator/shareDenominator)
  CELKOVA_VYMERA    // Celková výměra (totalArea)
  PODLAHOVA_VYMERA  // Podlahová výměra (floorArea)
  POCET_OBYVATEL    // Počet obyvatel (residents)
}

// Náklad (faktura) na dům
model Cost {
  id              String   @id @default(cuid())
  buildingId      String
  serviceId       String
  amount          Float
  description     String
  invoiceNumber   String?
  invoiceDate     DateTime
  vatAmount       Float?
  period          Int      // rok vyúčtování
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  building        Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("costs")
}

// Měřidlo
model Meter {
  id              String     @id @default(cuid())
  unitId          String
  serialNumber    String     // výrobní číslo měřidla
  type            MeterType
  initialReading  Float      @default(0)
  isActive        Boolean    @default(true)
  installedAt     DateTime?  // datum instalace
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  unit            Unit       @relation(fields: [unitId], references: [id], onDelete: Cascade)
  readings        MeterReading[]
  service         Service?   @relation(fields: [serviceId], references: [id])
  serviceId       String?

  @@unique([unitId, serialNumber])
  @@map("meters")
}

enum MeterType {
  HEATING        // Teplo
  COLD_WATER     // Vodoměry SV
  HOT_WATER      // Vodoměry TUV
  ELECTRICITY    // Elektroměry
}

// Odečet měřidla
model MeterReading {
  id              String   @id @default(cuid())
  meterId         String
  readingDate     DateTime
  value           Float    // hodnota odečtu
  startValue      Float?   // počáteční stav v období (import)
  endValue        Float?   // konečný stav v období (import)
  period          Int      // rok vyúčtování
  consumption     Float?   // vypočtená spotřeba
  dateStart       DateTime? // začátek období odečtu
  dateEnd         DateTime? // konec období odečtu
  precalculatedCost Float? // předvypočítaný náklad z importu (např. pro Teplo)
  note            String?
  createdAt       DateTime @default(now())

  meter           Meter    @relation(fields: [meterId], references: [id], onDelete: Cascade)

  @@map("meter_readings")
}

// Předpis záloh (na rok)
model AdvancePayment {
  id              String   @id @default(cuid())
  serviceId       String
  year            Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  service         Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  records         AdvancePaymentRecord[]

  @@unique([serviceId, year])
  @@map("advance_payments")
}

// Konkrétní předpis zálohy pro jednotku
model AdvancePaymentRecord {
  id                  String          @id @default(cuid())
  advancePaymentId    String
  unitId              String
  monthlyAmount       Float
  createdAt           DateTime        @default(now())

  advancePayment      AdvancePayment  @relation(fields: [advancePaymentId], references: [id], onDelete: Cascade)
  unit                Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([advancePaymentId, unitId])
  @@map("advance_payment_records")
}

// Nový granularní měsíční předpis (preferovaný zdroj pro výpočty a UI)
model AdvanceMonthly {
  id         String   @id @default(cuid())
  unitId     String
  serviceId  String
  year       Int
  month      Int      // 1-12
  amount     Float    // Kč
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  unit       Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([unitId, serviceId, year, month])
  @@map("advance_monthly")
}

// Platba (úhrada zálohy)
model Payment {
  id              String   @id @default(cuid())
  unitId          String
  amount          Float
  paymentDate     DateTime
  variableSymbol  String
  period          Int      // rok
  description     String?
  createdAt       DateTime @default(now())

  unit            Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Počet osob v jednotce (pro každý měsíc)
model PersonMonth {
  id              String   @id @default(cuid())
  unitId          String
  year            Int
  month           Int      // 1-12
  personCount     Int
  createdAt       DateTime @default(now())

  unit            Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, year, month])
  @@map("person_months")
}

// Období vyúčtování
model BillingPeriod {
  id              String        @id @default(cuid())
  buildingId      String
  year            Int
  status          BillingStatus @default(DRAFT)
  note            String?       // Poznámka k vyúčtování (např. text do patičky)
  calculatedAt    DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  building        Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  results         BillingResult[]
  serviceCosts    BillingServiceCost[]

  @@unique([buildingId, year])
  @@map("billing_periods")
}

enum BillingStatus {
  DRAFT
  CALCULATED
  APPROVED
  SENT
}

// Výsledek vyúčtování pro jednotku
model BillingResult {
  id                    String         @id @default(cuid())
  billingPeriodId       String
  unitId                String
  totalCost             Float          // celkový náklad jednotky
  totalAdvancePrescribed Float         // celkem předepsáno
  totalAdvancePaid      Float          // celkem uhrazeno
  repairFund            Float          @default(0) // fond oprav
  result                Float          // přeplatek (kladné) / nedoplatek (záporné)
  monthlyPrescriptions  Json?          // Pole 12 čísel - předpisy po měsících
  monthlyPayments       Json?          // Pole 12 čísel - platby po měsících
  isPaid                Boolean        @default(false) // stav úhrady
  pdfGenerated          Boolean        @default(false)
  pdfUrl                String?
  emailSent             Boolean        @default(false)
  emailSentAt           DateTime?
  smsSent               Boolean        @default(false)
  smsSentAt             DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  billingPeriod         BillingPeriod  @relation(fields: [billingPeriodId], references: [id], onDelete: Cascade)
  unit                  Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)
  serviceCosts          BillingServiceCost[]

  @@unique([billingPeriodId, unitId])
  @@map("billing_results")
}

// Detail nákladu na službu pro jednotku v rámci vyúčtování
model BillingServiceCost {
  id                    String         @id @default(cuid())
  billingPeriodId       String
  billingResultId       String
  serviceId             String
  unitId                String
  buildingTotalCost     Float          // celkový náklad domu na službu
  buildingConsumption   Float?         // celková spotřeba domu (pro měřené služby)
  unitConsumption       Float?         // spotřeba jednotky
  unitCost              Float          // náklad jednotky na službu
  unitAdvance           Float          @default(0) // záloha na službu
  unitBalance           Float          @default(0) // přeplatek/nedoplatek na službu
  unitPricePerUnit      Float?         // Kč/jednotku (cena)
  unitAssignedUnits     Float?         // kolik jednotek připadá
  distributionBase      String?        // základ pro rozúčtování (např. "vlastnický podíl 100")
  calculationBasis      String?        // popis výpočtu (pro kontrolu)
  createdAt             DateTime       @default(now())

  billingPeriod         BillingPeriod  @relation(fields: [billingPeriodId], references: [id], onDelete: Cascade)
  billingResult         BillingResult  @relation(fields: [billingResultId], references: [id], onDelete: Cascade)
  service               Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([billingResultId, serviceId])
  @@map("billing_service_costs")
}

// Uložené konfigurace výpočtů (verzování nastavení)
model CalculationConfig {
  id          String   @id @default(cuid())
  buildingId  String
  name        String   // Název verze (např. "Nastavení 2024 - verze 1")
  description String?
  createdAt   DateTime @default(now())
  
  // Uložená konfigurace jako JSON
  // Obsahuje pole objektů: { serviceCode: string, methodology: string, unitPrice: number, ... }
  config      Json     

  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@map("calculation_configs")
}
